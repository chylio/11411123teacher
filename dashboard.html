<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åç¾æ³å„€è¡¨æ¿</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f7f9fc; /* Light background */
        }
        .metric-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vibrant-purple': '#8B5CF6',
                        'vibrant-pink': '#EC4899',
                        'vibrant-yellow': '#FCD34D',
                        'deep-blue': '#1E3A8A'
                    }
                }
            }
        }
        
        // ğŸš¨ IMPORTANT: é€™å€‹ URL å¿…é ˆæ˜¯æ‚¨éƒ¨ç½²çš„ Apps Script Web App URL
        // å®ƒæœƒç”¨æ–¼ç™¼é€ GET è«‹æ±‚ç²å–å ±åæ•¸æ“š
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyVqT7XhAM9n4KItbOzZO6tyGeE1Spp8rnbZ22m_b1nTkxMEAbKM1M6Onc4Jk7Of-d1bg/exec'; 

        // è¼‰å…¥å„€è¡¨æ¿è³‡æ–™
        async function loadDashboard() {
            const statusText = document.getElementById('statusText');
            const dashboardContent = document.getElementById('dashboardContent');
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            statusText.textContent = 'è®€å–å ±åè³‡æ–™ä¸­... è«‹ç¨å€™ (ç¢ºä¿ Apps Script å·²éƒ¨ç½² doGet å‡½æ•¸)';
            statusText.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            
            console.log('--- å˜—è©¦è®€å– Apps Script è³‡æ–™ ---');
            console.log('Apps Script URL:', APPS_SCRIPT_URL);

            try {
                // ç™¼é€ GET è«‹æ±‚åˆ° Apps Script
                // æ³¨æ„ï¼šåœ¨ç€è¦½å™¨ä¸­è®€å– Apps Script JSON è³‡æ–™å¸¸é‡åˆ° CORS å•é¡Œ
                // æˆ‘å€‘ä½¿ç”¨ 'no-cors' æ¨¡å¼ä¾†é¿å…ç€è¦½å™¨é˜»æ“‹ï¼Œä½†é€™è¦æ±‚ Apps Script å¿…é ˆæ­£ç¢ºé…ç½® ContentService
                const response = await fetch(APPS_SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                
                // ç”±æ–¼ 'no-cors' æ¨¡å¼æœƒéš±è—å¯¦éš›ç‹€æ…‹ï¼Œä¸” JSON è®€å–å¯èƒ½æœƒå¤±æ•—ï¼Œæˆ‘å€‘å˜—è©¦ç›´æ¥è®€å–æ–‡æœ¬ä¸¦æ‰‹å‹•è§£æ
                const text = await response.text();
                
                // å˜—è©¦è§£æ JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("JSON è§£æå¤±æ•—ï¼Œå¯èƒ½Apps ScriptéŸ¿æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–CORSå•é¡Œå°è‡´ã€‚", text);
                    throw new Error("Apps Script éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿ doGet è¿”å›çš„æ˜¯ ContentService.MimeType.JSON");
                }

                if (data.error) {
                    throw new Error(`Apps Script éŒ¯èª¤: ${data.error}`);
                }

                // è™•ç†ä¸¦é¡¯ç¤ºè³‡æ–™
                renderDashboard(data);
                
            } catch (error) {
                console.error("è¼‰å…¥å„€è¡¨æ¿è³‡æ–™å¤±æ•—:", error);
                statusText.textContent = `è¼‰å…¥è³‡æ–™å¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥ Apps Script çš„éƒ¨ç½²å’Œç¶²çµ¡é€£æ¥ã€‚`;
                statusText.classList.remove('text-vibrant-purple');
                statusText.classList.add('text-red-600', 'bg-red-100', 'p-4', 'rounded-lg');
            } finally {
                 // éš±è—ç‹€æ…‹è¨Šæ¯ï¼Œé¡¯ç¤ºå…§å®¹
                statusText.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString('zh-TW');
            }
        }

        // è™•ç†è³‡æ–™ä¸¦æ¸²æŸ“å„€è¡¨æ¿
        function renderDashboard(data) {
            const totalRegistrations = data.totalRegistrations;
            const registrationData = data.data || [];
            
            // 1. ç¸½å ±åäººæ•¸
            document.getElementById('totalCount').textContent = totalRegistrations;

            // 2. çµ±è¨ˆè·ç¨±åˆ†ä½ˆ (Title: æ¨™é ­åç¨±)
            const titleCounts = countBy(registrationData, 'è·ç¨±');
            renderDistribution('titleDistribution', titleCounts, totalRegistrations);

            // 3. çµ±è¨ˆå–®ä½åˆ†ä½ˆ (Unit: æ¨™é ­åç¨±)
            const unitCounts = countBy(registrationData, 'å–®ä½');
            renderDistribution('unitDistribution', unitCounts, totalRegistrations, 10); // åªé¡¯ç¤ºå‰ 10 å€‹å–®ä½
        }

        // è¼”åŠ©å‡½æ•¸ï¼šçµ±è¨ˆåˆ†ä½ˆ
        function countBy(dataArray, key) {
            return dataArray.reduce((acc, item) => {
                const value = item[key] ? String(item[key]).trim() : 'æœªå¡«å¯«';
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {});
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“åˆ†ä½ˆåœ–è¡¨ (ä½¿ç”¨ç°¡å–®çš„æ¢ç‹€åœ–)
        function renderDistribution(elementId, counts, total, limit = Infinity) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
            
            // æ ¹æ“šæ•¸é‡æ’åº (é™å†ª)
            let sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            // é™åˆ¶é¡¯ç¤ºçš„é …ç›®æ•¸
            const limitedCounts = sortedCounts.slice(0, limit);
            const otherCount = sortedCounts.slice(limit).reduce((sum, [, count]) => sum + count, 0);

            limitedCounts.forEach(([label, count]) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                
                // æ±ºå®šé¡è‰² (å¯é¸)
                let barColor = 'bg-vibrant-purple';
                if (elementId === 'unitDistribution') {
                    barColor = 'bg-vibrant-yellow';
                } else if (label.includes('é†«å¸«')) {
                    barColor = 'bg-vibrant-pink';
                }

                const bar = `
                    <div class="mb-3">
                        <div class="flex justify-between text-sm font-medium text-gray-700">
                            <span>${label}</span>
                            <span>${count} äºº (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="h-3 rounded-full ${barColor} transition-all duration-700 ease-out" 
                                 style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += bar;
            });
            
            if (otherCount > 0) {
                 const otherPercentage = total > 0 ? ((otherCount / total) * 100).toFixed(1) : 0;
                 const otherBar = `
                    <div class="mb-3 opacity-60">
                        <div class="flex justify-between text-sm font-medium text-gray-700">
                            <span>å…¶ä»–å–®ä½/è·ç¨±...</span>
                            <span>${otherCount} äºº (${otherPercentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="h-3 rounded-full bg-gray-500 transition-all duration-700 ease-out" 
                                 style="width: ${otherPercentage}%;"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += otherBar;
            }
        }
        
        // åˆå§‹åŒ–è¼‰å…¥
        window.onload = loadDashboard;
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        
        <!-- Header -->
        <header class="text-center mb-10 p-6 rounded-xl bg-white shadow-lg">
            <h1 class="text-4xl font-extrabold text-deep-blue">
                å¥‡ç¾æœˆâ”€æ•™å­¸å…±è­˜ç‡Ÿ å ±åç¾æ³å„€è¡¨æ¿
            </h1>
            <p class="text-gray-500 mt-2">æœ€å¾Œæ›´æ–°æ™‚é–“: <span id="lastUpdated">${new Date().toLocaleString('zh-TW')}</span></p>
            <button onclick="loadDashboard()" 
                    class="mt-4 px-6 py-2 bg-vibrant-pink text-white font-bold rounded-full shadow-md hover:bg-vibrant-purple transition duration-200 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.126a8.974 8.974 0 00-2.486 3.966c-.322 1.353-.418 2.766-.275 4.14a1 1 0 001.986.115c-.093-1.071-.027-2.181.203-3.266A7.07 7.07 0 0110 5a7.07 7.07 0 015.568 2.875c.23.685.296 1.352.203 2.053a1 1 0 101.986.115c.143-1.374.047-2.787-.275-4.14A8.975 8.975 0 0015 3.126V3a1 1 0 012 0v2a1 1 0 01-1 1h-2a1 1 0 010-2h.586A8.966 8.966 0 0010 3.013 8.966 8.966 0 004.414 5H5a1 1 0 010 2H3a1 1 0 01-1-1V3a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                é‡æ–°æ•´ç†æ•¸æ“š
            </button>
        </header>

        <!-- Status Message -->
        <div id="statusText" class="text-center text-lg font-medium text-vibrant-purple hidden"></div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            
            <!-- ç¸½å ±åäººæ•¸ Metric Card -->
            <div class="mb-8">
                <div class="metric-card bg-white p-8 rounded-xl border-b-8 border-vibrant-pink">
                    <p class="text-xl font-semibold text-gray-500">ç¸½å ±åäººæ•¸</p>
                    <p id="totalCount" class="text-7xl font-extrabold text-vibrant-pink mt-4">0</p>
                    <p class="mt-2 text-gray-500">å·²æˆåŠŸå¯«å…¥ Google Sheets çš„ç¸½è¨˜éŒ„æ•¸</p>
                </div>
            </div>

            <!-- åˆ†ä½ˆåœ–è¡¨ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- è·ç¨±åˆ†ä½ˆ -->
                <div class="metric-card bg-white p-6 rounded-xl border-t-8 border-vibrant-purple">
                    <h2 class="text-2xl font-bold text-deep-blue mb-6 border-b pb-2">ğŸ“Š è·ç¨± (Title) åˆ†ä½ˆ</h2>
                    <div id="titleDistribution" class="space-y-4">
                        <!-- Chart data will be rendered here -->
                    </div>
                </div>

                <!-- å–®ä½åˆ†ä½ˆ -->
                <div class="metric-card bg-white p-6 rounded-xl border-t-8 border-vibrant-yellow">
                    <h2 class="text-2xl font-bold text-deep-blue mb-6 border-b pb-2">ğŸ¥ å–®ä½ (Unit) åˆ†ä½ˆ (å‰åå)</h2>
                    <div id="unitDistribution" class="space-y-4">
                        <!-- Chart data will be rendered here -->
                    </div>
                </div>
            </div>
            
        </div>

    </div>

</body>
</html>
